# MetamorphUI - Cursor Rules

## üéØ But de l'application

MetamorphUI est un SaaS qui transforme automatiquement les designs Figma (ouPenpot) en code Token et composants React (ou Vue) pr√™t pour la production.

### Fonctionnalit√©s principales

- **Import depuis Figma** : Connexion √† des fichiers Figma via l'API Figma
- **G√©n√©ration de tokens de design** : Extraction automatique des variables Figma (couleurs, typographie, espacements) et export en CSS custom properties
- **G√©n√©ration de composants React** : Transformation des composants Figma en composants React r√©utilisables et pr√™ts pour la production
- **Synchronisation** : Mise √† jour automatique des tokens et composants quand les designs Figma changent

### Public cible

D√©veloppeurs et √©quipes design/dev qui veulent automatiser le passage du design (Figma) au code (React).

## üèóÔ∏è Architecture technique

### Stack

- **Framework** : Next.js 14 (App Router)
- **Language** : TypeScript
- **Base de donn√©es** : PostgreSQL avec Prisma ORM
- **Authentification** : NextAuth.js (Credentials, Google OAuth, GitHub OAuth)
- **Email** : Resend pour l'envoi d'emails de v√©rification
- **Styling** : Tailwind CSS + shadcn/ui
- **Internationalisation** : next-intl (FR/EN)
- **Th√®me** : Syst√®me custom (remplace next-themes)
- **Tests** : Vitest + Testing Library

### Structure du projet

```
app/
  ‚îú‚îÄ‚îÄ api/              # Routes API (NextAuth, signup, verification, etc.)
  ‚îÇ   ‚îî‚îÄ‚îÄ user/preferences/  # Routes pour pr√©f√©rences utilisateur (language, theme)
  ‚îú‚îÄ‚îÄ dashboard/        # Dashboard utilisateur
  ‚îú‚îÄ‚îÄ signin/           # Page de connexion
  ‚îú‚îÄ‚îÄ signup/           # Page d'inscription
  ‚îú‚îÄ‚îÄ verify-email/     # V√©rification d'email
  ‚îî‚îÄ‚îÄ resend-verification/ # Renvoi d'email de v√©rification

components/
  ‚îú‚îÄ‚îÄ auth/             # Composants d'authentification
  ‚îú‚îÄ‚îÄ ui/               # Composants shadcn/ui
  ‚îú‚îÄ‚îÄ theme-provider.tsx # Provider custom pour le th√®me
  ‚îú‚îÄ‚îÄ theme-toggle.tsx   # S√©lecteur de th√®me
  ‚îú‚îÄ‚îÄ theme-sync.tsx     # Synchronisation du th√®me
  ‚îú‚îÄ‚îÄ language-toggle.tsx # S√©lecteur de langue
  ‚îú‚îÄ‚îÄ language-sync.tsx  # Synchronisation de la langue
  ‚îî‚îÄ‚îÄ session-provider.tsx # Provider pour NextAuth SessionProvider

lib/
  ‚îú‚îÄ‚îÄ auth.ts           # Configuration NextAuth
  ‚îú‚îÄ‚îÄ prisma.ts         # Client Prisma
  ‚îú‚îÄ‚îÄ email.ts          # Service d'envoi d'emails (Resend)
  ‚îú‚îÄ‚îÄ session.ts        # Utilitaires de session
  ‚îú‚îÄ‚îÄ language.ts       # Gestion de la langue (DB > cookie > system)
  ‚îú‚îÄ‚îÄ theme.ts          # Gestion du th√®me (DB > cookie > system)
  ‚îî‚îÄ‚îÄ theme-context.tsx # Context React pour le th√®me

i18n/
  ‚îú‚îÄ‚îÄ routing.ts        # Configuration next-intl
i18n.ts                 # Configuration getRequestConfig pour next-intl
messages/
  ‚îú‚îÄ‚îÄ fr.json           # Traductions fran√ßaises
  ‚îî‚îÄ‚îÄ en.json           # Traductions anglaises
middleware.ts           # Middleware pour d√©tection langue/th√®me

prisma/
  ‚îî‚îÄ‚îÄ schema.prisma     # Sch√©ma de base de donn√©es

__tests__/              # Tests unitaires et d'int√©gration
  ‚îú‚îÄ‚îÄ api/              # Tests des routes API
  ‚îÇ   ‚îî‚îÄ‚îÄ auth/
  ‚îÇ       ‚îú‚îÄ‚îÄ signup.test.ts
  ‚îÇ       ‚îî‚îÄ‚îÄ verify-email.test.ts
  ‚îú‚îÄ‚îÄ lib/              # Tests de la logique m√©tier
  ‚îÇ   ‚îú‚îÄ‚îÄ theme.test.ts
  ‚îÇ   ‚îî‚îÄ‚îÄ language.test.ts
  ‚îî‚îÄ‚îÄ components/       # Tests des composants (√† venir)

vitest.config.ts        # Configuration Vitest
vitest.setup.ts         # Setup global des tests
.husky/pre-commit       # Hook Git pour lancer les tests avant commit
```

## üìä Mod√®le de donn√©es

### User

- Informations utilisateur (email, nom, mot de passe hash√©)
- `emailVerified` : Date de v√©rification de l'email (null si non v√©rifi√©)
- `language` : Pr√©f√©rence de langue (fr, en) - nullable
- `theme` : Pr√©f√©rence de th√®me (light, dark, system) - nullable
- Relations : accounts (OAuth), sessions, projects

### Project

- Projet li√© √† un fichier Figma
- Contient `figmaFileId` et `figmaApiKey` (chiffr√©e)
- Relation : user, tokens

### Token

- Tokens de design extraits de Figma
- Types : color, typography, spacing, etc.
- Contient `figmaVariableId` si disponible
- Relation : project

### Account

- Comptes OAuth (Google, GitHub)
- G√©r√© par NextAuth avec PrismaAdapter

### VerificationToken

- Tokens pour la v√©rification d'email
- Expire apr√®s 24 heures

## üîê Authentification

### Flux d'inscription

1. Utilisateur s'inscrit avec email/password
2. Compte cr√©√© avec `emailVerified: null`
3. Token de v√©rification g√©n√©r√© et stock√©
4. Email de v√©rification envoy√© via Resend
5. Utilisateur clique sur le lien ‚Üí email v√©rifi√©
6. Utilisateur peut se connecter

### OAuth (Google/GitHub)

- Les utilisateurs OAuth n'ont pas besoin de v√©rifier leur email (d√©j√† v√©rifi√© par le provider)
- `emailVerified` est automatiquement rempli par NextAuth
- Support de la liaison de comptes avec `allowDangerousEmailAccountLinking: true`

### S√©curit√©

- Les utilisateurs non v√©rifi√©s ne peuvent pas se connecter
- Les tokens de v√©rification expirent apr√®s 24h
- Possibilit√© de renvoyer un email de v√©rification via `/resend-verification`

## üìß Email

### Configuration

- Service : Resend
- Domaine v√©rifi√© : `davidduprat.fr` (temporaire, en attente de `metamorphui.com`)
- From : `noreply@davidduprat.fr`

### Emails envoy√©s

- Email de v√©rification lors de l'inscription
- Email de renvoi de v√©rification si le lien a expir√©

## üåç Internationalisation

### Syst√®me de langue

- **Biblioth√®que** : next-intl
- **Langues support√©es** : Fran√ßais (fr), Anglais (en)
- **Priorit√© de d√©termination** : Pr√©f√©rence utilisateur (DB) > Cookie > Pr√©f√©rence syst√®me
- **Composants** :
  - `LanguageToggle` : S√©lecteur de langue dans le header (affiche FR/EN)
  - `LanguageSync` : Synchronisation cookie/DB apr√®s connexion/d√©connexion
- **Fichiers de traduction** : `messages/fr.json` et `messages/en.json`
- **Middleware** : D√©tection automatique de la langue via `middleware.ts`
- **API Route** : `/api/user/preferences/language` pour sauvegarder la pr√©f√©rence

### Logique de priorit√©

1. **Utilisateur connect√©** : DB > Cookie > Syst√®me (sauvegarde automatique si pas de pr√©f√©rence DB)
2. **Utilisateur non connect√©** : Cookie > Syst√®me

## üé® UI/UX

### Th√®me

- **Syst√®me** : Provider custom (remplace next-themes)
- **Th√®mes support√©s** : light, dark, system
- **Priorit√© de d√©termination** : Pr√©f√©rence utilisateur (DB) > Cookie > Pr√©f√©rence syst√®me
- **Composants** :
  - `ThemeProvider` : Provider React custom (`lib/theme-context.tsx`)
  - `ThemeToggle` : S√©lecteur de th√®me dans le header (ic√¥nes Sun/Moon/Monitor)
  - `ThemeSync` : Synchronisation cookie/DB apr√®s connexion/d√©connexion
- **D√©tection syst√®me** : Via `prefers-color-scheme` (header + client-side)
- **Script inline** : Application imm√©diate du th√®me avant hydratation React (√©vite le flash)
- **API Route** : `/api/user/preferences/theme` pour sauvegarder la pr√©f√©rence

### Logique de priorit√©

1. **Utilisateur connect√©** : DB > Cookie > Syst√®me (sauvegarde automatique si pas de pr√©f√©rence DB)
2. **Utilisateur non connect√©** : Cookie > Syst√®me

### Composants

- Utilisation de shadcn/ui pour les composants de base
- Tailwind CSS pour le styling
- Design responsive

## üîÑ Conventions de code

### Naming

- Composants : PascalCase (`SignUpForm.tsx`)
- Fichiers : kebab-case pour les routes, PascalCase pour les composants
- Variables : camelCase
- Types/Interfaces : PascalCase

### Imports

- Imports absolus avec `@/` (configur√© dans `tsconfig.json`)
- Ordre : React ‚Üí Next.js ‚Üí librairies externes ‚Üí composants locaux ‚Üí styles

### API Routes

- Routes dans `app/api/`
- Utilisation de `NextResponse` pour les r√©ponses
- Gestion d'erreurs avec try/catch et codes HTTP appropri√©s

### Base de donn√©es

- Utilisation de Prisma pour toutes les requ√™tes
- Transactions pour les op√©rations multiples
- Validation des donn√©es avant insertion

## üß™ Tests

### Framework et configuration

- **Framework** : Vitest (remplace Jest, plus rapide et compatible avec Next.js 14)
- **Configuration** : `vitest.config.ts` et `vitest.setup.ts`
- **Environnement** : jsdom pour les tests de composants React
- **Alias** : Support des imports `@/` comme dans le projet

### Structure des tests

```
__tests__/
  ‚îú‚îÄ‚îÄ api/              # Tests des routes API
  ‚îÇ   ‚îî‚îÄ‚îÄ auth/
  ‚îÇ       ‚îú‚îÄ‚îÄ signup.test.ts
  ‚îÇ       ‚îî‚îÄ‚îÄ verify-email.test.ts
  ‚îú‚îÄ‚îÄ lib/              # Tests de la logique m√©tier
  ‚îÇ   ‚îú‚îÄ‚îÄ theme.test.ts
  ‚îÇ   ‚îî‚îÄ‚îÄ language.test.ts
  ‚îî‚îÄ‚îÄ components/       # Tests des composants (√† venir)

vitest.config.ts        # Configuration Vitest
vitest.setup.ts         # Setup global des tests
.husky/pre-commit       # Hook Git pour lancer les tests avant commit
```

### Conventions de nommage

- Fichiers de test : `*.test.ts` ou `*.spec.ts`
- Un fichier de test par fichier source
- Nom du fichier : `[nom-du-fichier-source].test.ts`

### Quand √©crire des tests

**Priorit√© haute (obligatoire) :**

- Logique m√©tier critique (`lib/theme.ts`, `lib/language.ts`)
- Routes API (`app/api/**/route.ts`)
- Fonctions utilitaires complexes

**Priorit√© moyenne (recommand√©) :**

- Composants avec logique complexe
- Hooks personnalis√©s
- Middleware

**Priorit√© basse (optionnel) :**

- Composants UI simples (shadcn/ui)
- Pages statiques

### Comment √©crire des tests

**Structure d'un test :**

```typescript
import { describe, it, expect, vi, beforeEach } from 'vitest';

// Mock des d√©pendances externes
vi.mock('@/lib/prisma', () => ({
  prisma: { user: { findUnique: vi.fn() } },
}));

describe('nomDeLaFonction', () => {
  beforeEach(() => {
    vi.clearAllMocks();
    vi.resetAllMocks();
  });

  it('should do something when condition', async () => {
    // Arrange : pr√©parer les donn√©es
    // Act : ex√©cuter la fonction
    // Assert : v√©rifier le r√©sultat
  });
});
```

**Bonnes pratiques :**

- Un test = un comportement sp√©cifique
- Nommer les tests de mani√®re descriptive : `should [action] when [condition]`
- Utiliser `beforeEach` pour nettoyer les mocks entre les tests
- Mocker toutes les d√©pendances externes (Prisma, NextAuth, etc.)
- Tester les cas d'erreur ET les cas de succ√®s
- Tester les cas limites (valeurs null, undefined, etc.)

**Mocks √† utiliser :**

- `vi.mock()` pour mocker les modules
- `vi.fn()` pour cr√©er des fonctions mock√©es
- `vi.mocked()` pour typer les mocks
- `mockResolvedValue()` / `mockRejectedValue()` pour les promesses

### Pre-commit hook

- **Configuration** : Husky avec hook pre-commit
- **Comportement** : Les tests se lancent automatiquement avant chaque `git commit`
- **Si les tests √©chouent** : Le commit est bloqu√©
- **Contournement** : `git commit --no-verify` (√† utiliser avec pr√©caution)

**Workflow recommand√© :**

1. D√©velopper une fonctionnalit√©
2. √âcrire/modifier les tests correspondants
3. Lancer `npm run test:watch` pour d√©veloppement
4. Commit (les tests se lancent automatiquement)
5. Si les tests passent ‚Üí commit cr√©√©
6. Si les tests √©chouent ‚Üí corriger avant de commit

### Commandes disponibles

```bash
npm test              # Lance tous les tests une fois
npm run test:watch    # Mode watch (relance automatique)
npm run test:ui       # Interface graphique Vitest
npm run test:coverage # Rapport de couverture de code
```

### Couverture actuelle

- ‚úÖ Routes API : `/api/auth/signup`, `/api/auth/verify-email`
- ‚úÖ Logique m√©tier : `lib/theme.ts`, `lib/language.ts`
- ‚è≥ Composants UI : √Ä venir
- ‚è≥ Middleware : √Ä venir

**Total actuel : 38 tests passent**

### Exemples de tests

**Test d'une route API :**

```typescript
it('should create a new user successfully', async () => {
  vi.mocked(prisma.user.findUnique).mockResolvedValue(null);
  vi.mocked(prisma.user.create).mockResolvedValue(mockUser);

  const response = await POST(request);
  const data = await response.json();

  expect(response.status).toBe(201);
  expect(data.requiresVerification).toBe(true);
});
```

**Test d'une fonction utilitaire :**

```typescript
it('should return user theme from database', async () => {
  vi.mocked(prisma.user.findUnique).mockResolvedValue({ theme: 'dark' });

  const theme = await getUserTheme('user-123');

  expect(theme).toBe('dark');
});
```

## üöÄ D√©ploiement

### Variables d'environnement requises

```env
# Base de donn√©es
DATABASE_URL="postgresql://..."

# NextAuth
NEXTAUTH_URL="http://localhost:3000"
NEXTAUTH_SECRET="..."

# OAuth (optionnel)
GOOGLE_CLIENT_ID="..."
GOOGLE_CLIENT_SECRET="..."
GITHUB_CLIENT_ID="..."
GITHUB_CLIENT_SECRET="..."

# Email (Resend)
RESEND_API_KEY="..."
RESEND_FROM_EMAIL="noreply@davidduprat.fr"

# Encryption (pour les API keys Figma)
ENCRYPTION_KEY="..."
```

## üìù Notes importantes

### √Ä faire

- [x] Internationalisation (FR/EN) - ‚úÖ Impl√©ment√©
- [x] Tests unitaires et d'int√©gration - ‚úÖ Impl√©ment√© (Vitest, 38 tests)
- [ ] Tests des composants UI
- [ ] Int√©gration API Figma
- [ ] G√©n√©ration de tokens depuis Figma
- [ ] G√©n√©ration de composants React depuis Figma
- [ ] Dashboard pour g√©rer les projets
- [ ] Export de tokens en CSS/JSON

### Domaines

- Domaine temporaire : `davidduprat.fr`
- Domaine pr√©vu : `metamorphui.com` (en attente de cr√©ation chez Scaleway)

### S√©curit√©

- Les API keys Figma doivent √™tre chiffr√©es avant stockage
- Validation stricte des entr√©es utilisateur
- Protection CSRF avec NextAuth
- Rate limiting √† impl√©menter pour les routes API

## üêõ Debugging

### Logs

- Les logs OAuth sont activ√©s en mode d√©veloppement
- Logs d√©taill√©s pour l'envoi d'emails
- Console.log pour le debugging (√† remplacer par un vrai logger en production)
- **Note** : Les logs de debug verbeux ont √©t√© supprim√©s, seuls les `console.error` et logs utiles sont conserv√©s

### Erreurs communes

- Erreur "Email not verified" : L'utilisateur doit v√©rifier son email
- Erreur "OAuthAccountNotLinked" : Compte OAuth non li√© √† un compte existant
- Erreur Resend 403 : Domaine non v√©rifi√© ou email non autoris√© (mode test)
